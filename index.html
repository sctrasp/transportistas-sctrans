<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buscar Transportistas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f7f7f7; }
    .container { max-width: 1200px; margin: auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #0033a0; color: white; }
    input, button, textarea { padding: 10px; margin: 10px 0; width: 100%; max-width: 300px; }
    button { background-color: #0033a0; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .filters label { margin-right: 10px; }
    .checkbox-group { margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <div style="text-align: right">
    <button onclick="window.location.href='resumen.html'">üìÑ Ver resumen de cotizaciones</button>
  </div>

  <h1>Buscar Transportistas</h1>
  <div class="filters">
    <label>Origen:<br/><input type="text" id="origen" placeholder="Ej. Valencia" /></label>
    <label>Destino:<br/><input type="text" id="destino" placeholder="Ej. Lugo" /></label>
  </div>
  <div class="checkbox-group">
    <label><input type="checkbox" id="todos" checked /> Todos</label>
    <label><input type="checkbox" id="adr" /> ADR</label>
    <label><input type="checkbox" id="completo" /> Completo</label>
  </div>
  <button onclick="buscarTransportistas()">Buscar</button>

  <table>
    <thead>
      <tr>
        <th>Seleccionar</th>
        <th>Nombre</th>
        <th>Total Viajes</th>
        <th>Direcci√≥n</th>
        <th>Tel√©fono</th>
        <th>Email</th>
        <th>ADR</th>
        <th>Completo</th>
      </tr>
    </thead>
    <tbody id="resultado"></tbody>
  </table>
  <label><input type="checkbox" id="selectAll" /> Seleccionar todos</label>

  <h2>Solicitar Presupuesto</h2>
  <textarea id="mensaje" placeholder="Escribe tu mensaje aqu√≠..." rows="5"></textarea><br/>
  <button id="btnEnviar" onclick="enviarPresupuesto()" disabled>Pide presupuesto</button>
</div>

<script>
// Supabase init
const supabase = window.supabase.createClient(
  "https://dikaacfsinyptsgxbuyd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpa2FhY2ZzaW55cHRzZ3hidXlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwNjY1MDEsImV4cCI6MjA1NjY0MjUwMX0.K23pCGbP_OB0_VEpZ5_8Uyauhsz4dUdTtYCymidElYA"
);

const todosCheckbox = document.getElementById("todos");
const adrCheckbox = document.getElementById("adr");
const completoCheckbox = document.getElementById("completo");
const botonEnviar = document.getElementById("btnEnviar");
const selectAllCheckbox = document.getElementById("selectAll");

todosCheckbox.addEventListener("change", () => {
  adrCheckbox.disabled = todosCheckbox.checked;
  completoCheckbox.disabled = todosCheckbox.checked;
  if (todosCheckbox.checked) {
    adrCheckbox.checked = false;
    completoCheckbox.checked = false;
  }
});

function normalize(str) {
  return str.normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-zA-Z0-9 ]/g, "")
    .trim().toLowerCase();
}

async function buscarTransportistas() {
  botonEnviar.disabled = true;
  selectAllCheckbox.checked = false;
  const resultadoTabla = document.getElementById("resultado");
  resultadoTabla.innerHTML = "";

  const origen = normalize(document.getElementById("origen").value);
  const destino = normalize(document.getElementById("destino").value);
  if (!origen || !destino) return alert("‚ö†Ô∏è Escribe origen y destino");

  let query = supabase.from("transportistas")
    .select("nombre_transportista, total_viajes, direccion, telefono, telefono_movil, email, adr, completo")
    .ilike("origen", `%${origen}%`)
    .ilike("destino", `%${destino}%`);

  if (!todosCheckbox.checked) {
    if (adrCheckbox.checked) query = query.ilike("adr", "si");
    if (completoCheckbox.checked) query = query.ilike("completo", "si");
  }

  const { data, error } = await query;
  if (error || !data.length) {
    resultadoTabla.innerHTML = "<tr><td colspan='8'>‚ùå No se encontraron transportistas.</td></tr>";
    return;
  }

  const agrupados = {};
  data.forEach(t => {
    const nombre = t.nombre_transportista;
    if (!agrupados[nombre]) {
      agrupados[nombre] = {
        total_viajes: 0,
        direccion: t.direccion || "-",
        telefono: t.telefono || t.telefono_movil || "-",
        email: t.email || "-",
        adr: t.adr || "-",
        completo: t.completo || "-"
      };
    }
    agrupados[nombre].total_viajes += t.total_viajes || 0;
  });

  Object.keys(agrupados).forEach(nombre => {
    const t = agrupados[nombre];
    resultadoTabla.innerHTML += `
      <tr>
        <td><input type="checkbox" class="check-email" value="${t.email}" /></td>
        <td>${nombre}</td>
        <td>${t.total_viajes}</td>
        <td>${t.direccion}</td>
        <td>${t.telefono}</td>
        <td>${t.email}</td>
        <td>${t.adr}</td>
        <td>${t.completo}</td>
      </tr>`;
  });

  document.querySelectorAll(".check-email").forEach(cb => cb.checked = selectAllCheckbox.checked);
  selectAllCheckbox.addEventListener("change", () => {
    document.querySelectorAll(".check-email").forEach(cb => cb.checked = selectAllCheckbox.checked);
  });

  botonEnviar.disabled = false;
}

async function enviarPresupuesto() {
  const emails = [...document.querySelectorAll('.check-email:checked')].map(cb => cb.value);
  const mensaje = document.getElementById("mensaje").value;
  const origen = document.getElementById("origen").value;
  const destino = document.getElementById("destino").value;

  if (!emails.length) return alert("Selecciona al menos un transportista");
  if (!mensaje.trim()) return alert("Escribe un mensaje");

  const { error } = await supabase.from("cotizaciones_solicitadas").insert({
    origen, destino, emails_contactados: emails, mensaje
  });

  if (error) return alert("Error al guardar la solicitud");

  fetch("/.netlify/functions/sendEmail", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emails, mensaje })
  })
  .then(res => res.json())
  .then(data => alert(data.message || "‚úÖ Presupuesto solicitado!"))
  .catch(() => alert("‚ùå Error al enviar los emails"));
}
</script>
</body>
</html>
