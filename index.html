<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscar Transportistas</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #0033a0; color: white; }
    input, button, textarea { padding: 10px; margin: 10px 5px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .filters { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Buscar Transportistas</h1>
    <button onclick="window.location.href='resumen.html'"
            style="background-color: #0033a0; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer;">
      üìÑ Ver resumen de cotizaciones
    </button>
  </div>

  <label for="origen">Origen:</label>
  <input type="text" id="origen" placeholder="Ingrese origen" />

  <label for="destino">Destino:</label>
  <input type="text" id="destino" placeholder="Ingrese destino" />

  <div class="filters">
    <label><input type="checkbox" id="todos" checked /> Todos</label>
    <label><input type="checkbox" id="adr" /> ADR</label>
    <label><input type="checkbox" id="completo" /> Completo</label>
  </div>

  <button onclick="buscarTransportistas()">Buscar</button>

  <table>
    <thead>
      <tr>
        <th>Seleccionar</th>
        <th>Nombre</th>
        <th>Total Viajes</th>
        <th>Direcci√≥n</th>
        <th>Tel√©fono</th>
        <th>Email</th>
        <th>ADR</th>
        <th>Completo</th>
      </tr>
    </thead>
    <tbody id="resultado"></tbody>
  </table>

  <label><input type="checkbox" id="selectAll" /> Seleccionar todos</label>

  <h2>Solicitar Presupuesto</h2>
  <textarea id="mensaje" placeholder="Escribe tu mensaje aqu√≠..." rows="5" cols="50"></textarea><br />
  <button id="btnEnviar" onclick="enviarPresupuesto()" disabled>Pide presupuesto</button>

  <script>
    const SUPABASE_URL = "https://dikaacfsinyptsgxbuyd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // acorta per sicurezza
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function normalizarTexto(texto) {
      return texto
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .trim();
    }

    const todosCheckbox = document.getElementById("todos");
    const adrCheckbox = document.getElementById("adr");
    const completoCheckbox = document.getElementById("completo");
    const botonEnviar = document.getElementById("btnEnviar");
    const selectAllCheckbox = document.getElementById("selectAll");

    todosCheckbox.addEventListener("change", () => {
      const disabled = todosCheckbox.checked;
      adrCheckbox.disabled = disabled;
      completoCheckbox.disabled = disabled;
      if (disabled) {
        adrCheckbox.checked = false;
        completoCheckbox.checked = false;
      }
    });

    async function buscarTransportistas() {
      botonEnviar.disabled = true;
      selectAllCheckbox.checked = false;

      const origen = normalizarTexto(document.getElementById("origen").value);
      const destino = normalizarTexto(document.getElementById("destino").value);
      const resultadoTabla = document.getElementById("resultado");
      resultadoTabla.innerHTML = "";

      if (!origen || !destino) {
        alert("‚ö†Ô∏è Por favor, ingrese origen y destino.");
        return;
      }

      let query = supabase
        .from("transportistas")
        .select("nombre_transportista, total_viajes, direccion, telefono, telefono_movil, email, adr, completo")
        .ilike("origen", `%${origen}%`)
        .ilike("destino", `%${destino}%`);

      if (!todosCheckbox.checked) {
        if (adrCheckbox.checked) query = query.ilike("adr", "si");
        if (completoCheckbox.checked) query = query.ilike("completo", "si");
      }

      const { data, error } = await query;

      if (error) {
        alert("‚ùå Error al obtener transportistas.");
        console.error(error);
        return;
      }

      if (!data.length) {
        resultadoTabla.innerHTML = "<tr><td colspan='8'>‚ùå No se encontraron transportistas.</td></tr>";
        return;
      }

      const agrupados = {};
      data.forEach(t => {
        if (!agrupados[t.nombre_transportista]) {
          agrupados[t.nombre_transportista] = {
            total: 0,
            direccion: t.direccion || "-",
            telefono: t.telefono || t.telefono_movil || "-",
            email: t.email || "-",
            adr: t.adr || "-",
            completo: t.completo || "-"
          };
        }
        agrupados[t.nombre_transportista].total += t.total_viajes || 0;
      });

      Object.entries(agrupados).forEach(([nombre, t]) => {
        resultadoTabla.innerHTML += `
          <tr>
            <td><input type="checkbox" class="check-email" value="${t.email}" /></td>
            <td>${nombre}</td>
            <td>${t.total}</td>
            <td>${t.direccion}</td>
            <td>${t.telefono}</td>
            <td>${t.email}</td>
            <td>${t.adr}</td>
            <td>${t.completo}</td>
          </tr>`;
      });

      selectAllCheckbox.addEventListener("change", () => {
        document.querySelectorAll(".check-email")
          .forEach(cb => cb.checked = selectAllCheckbox.checked);
      });

      botonEnviar.disabled = false;
    }

    async function enviarPresupuesto() {
      const emails = [...document.querySelectorAll('.check-email:checked')].map(cb => cb.value);
      const mensaje = document.getElementById("mensaje").value;
      const origen = document.getElementById("origen").value.trim();
      const destino = document.getElementById("destino").value.trim();

      if (!emails.length) return alert("Seleccione al menos un transportista.");
      if (!mensaje) return alert("Escriba un mensaje.");

      const { error } = await supabase.from("cotizaciones_solicitadas").insert({
        origen, destino, emails_contactados: emails, mensaje
      });

      if (error) return alert("Error al guardar la solicitud.");

      fetch("/.netlify/functions/sendEmail", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ emails, mensaje })
      })
      .then(res => res.json())
      .then(data => alert(data.message || "‚úÖ Presupuesto solicitado correctamente!"))
      .catch(err => {
        console.error(err);
        alert("‚ùå Error al enviar los emails.");
      });
    }
  </script>
</body>
</html>
