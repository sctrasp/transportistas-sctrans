<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resumen de Cotizaciones Solicitadas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f8f8; }
    h1 { text-align: center; }
    .cotizacion { background: white; padding: 20px; margin: 20px auto; max-width: 1000px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; }
    .fecha { font-weight: bold; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #002f86; color: white; }
    textarea, input[type="text"] { width: 100%; padding: 6px; margin-bottom: 10px; }
    .btnGuardar {
      background: #0033a0; color: white; padding: 6px 12px;
      border: none; border-radius: 5px; cursor: pointer;
      position: absolute; top: 15px; right: 15px;
    }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>Resumen de Cotizaciones Solicitadas</h1>
<div id="contenedor"></div>

<script>
  const supabase = window.supabase.createClient(
    "https://dikaacfsinyptsgxbuyd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpa2FhY2ZzaW55cHRzZ3hidXlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwNjY1MDEsImV4cCI6MjA1NjY0MjUwMX0.K23pCGbP_OB0_VEpZ5_8Uyauhsz4dUdTtYCymidElYA"
  );

  async function cargarDatos() {
    const { data, error } = await supabase
      .from("cotizaciones_solicitadas")
      .select("id, origen, destino, fecha, emails_contactados, referencia_cliente, mensaje, precios")
      .order("fecha", { ascending: false });

    if (error) return console.error("Error al cargar cotizaciones:", error);

    const contenedor = document.getElementById("contenedor");
    contenedor.innerHTML = "";

    data.forEach(row => {
      const div = document.createElement("div");
      div.className = "cotizacion";
      div.style.position = "relative";

      let precios = {};
      if (typeof row.precios === "string") {
        try { precios = JSON.parse(row.precios); } catch { precios = {}; }
      } else {
        precios = row.precios || {};
      }

      const filas = row.emails_contactados.map(email => {
        const idBase64 = `${row.id}-${btoa(email)}`;
        const valor = precios[email] !== undefined ? precios[email] : "";
        return `
          <tr>
            <td>${email}</td>
            <td><input type="number" step="0.01" id="${idBase64}" value="${valor}"></td>
          </tr>`;
      }).join("");

      div.innerHTML = `
        <button class="btnGuardar" onclick="guardarCotizacion('${row.id}')">üíæ Guardar</button>
        <div class="fecha">${row.origen.toUpperCase()} ‚ûî ${row.destino.toUpperCase()}<br>Fecha: ${new Date(row.fecha).toLocaleString()}</div>
        <label>Referencia cliente:</label>
        <input type="text" id="ref-${row.id}" value="${row.referencia_cliente || ""}">
        <label>Mensaje enviado:</label>
        <textarea rows="4" id="msg-${row.id}">${row.mensaje || ""}</textarea>
        <label>Transportistas:</label>
        <table>
          <thead><tr><th>Email</th><th>Precio (‚Ç¨)</th></tr></thead>
          <tbody>${filas}</tbody>
        </table>
      `;

      contenedor.appendChild(div);
    });
  }

  async function guardarCotizacion(id) {
    const ref = document.getElementById(`ref-${id}`).value;
    const msg = document.getElementById(`msg-${id}`).value;
    const inputs = document.querySelectorAll(`input[id^='${id}-']`);
    let precios = {};
    inputs.forEach(input => {
      const encodedEmail = input.id.split("-").slice(1).join("-");
      const email = atob(encodedEmail);
      const valor = input.value.trim();
      if (valor !== "") precios[email] = parseFloat(valor);
    });

    const { error } = await supabase
      .from("cotizaciones_solicitadas")
      .update({
        referencia_cliente: ref,
        mensaje: msg,
        precios: precios,
        actualizado_en: new Date()
      })
      .eq("id", id);

    if (error) {
      alert("‚ùå Error al guardar");
      console.error(error);
    } else {
      alert("‚úÖ Datos guardados correctamente");
    }
  }

  cargarDatos();
</script>

</body>
</html>
